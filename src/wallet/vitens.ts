import { wsProvider } from "./node"
import * as vite from "@vite/vitejs"

const nullAddress = vite.wallet.getAddressFromOriginalAddress(
    "00".repeat(21)
)
export const VITENS_OFFCHAIN_CODE = Buffer.from(
    "60806040526004361061007c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630532e9a41461007e5780632db37ced1461014b57806332876eb8146101fe5780637a5c56f414610258578063b109ad0714610276578063f7ee8b63146103375761007c565b005b6100cf600480360360408110156100955760006000fd5b81019080803574ffffffffffffffffffffffffffffffffffffffffff169060200190929190803560ff169060200190929190505050610397565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156101105780820151818401525b6020810190506100f4565b50505050905090810190601f16801561013d5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101a6600480360360608110156101625760006000fd5b81019080803574ffffffffffffffffffffffffffffffffffffffffff169060200190929190803560ff169060200190929190803590602001909291905050506104ae565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156101ea5780820151818401525b6020810190506101ce565b505050509050019250505060405180910390f35b610242600480360360208110156102155760006000fd5b81019080803574ffffffffffffffffffffffffffffffffffffffffff169060200190929190505050610583565b6040518082815260200191505060405180910390f35b6102606105dc565b6040518082815260200191505060405180910390f35b6102f36004803603602081101561028d5760006000fd5b81019080803590602001906401000000008111156102ab5760006000fd5b8201836020820111156102be5760006000fd5b803590602001918460018302840111640100000000831117156102e15760006000fd5b909192939090919293905050506105ee565b604051808274ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61033f610649565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156103835780820151818401525b602081019050610367565b505050509050019250505060405180910390f35b6060600260005060008474ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000216000508260ff168154811015156103f057fe5b906000526020600021906002020160005b506000016000508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561049c5780601f106104715761010080835404028352916020019161049c565b820191906000526020600021905b81548152906001019060200180831161047f57829003601f168201915b505050505090506104a8565b92915050565b6060600260005060008574ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000216000508360ff1681548110151561050757fe5b906000526020600021906002020160005b5060010160005080548060200260200160405190810160405280929190818152602001828054801561057057602002820191906000526020600021905b81600050546000191681526020019060010190808311610555575b5050505050905061057c565b9392505050565b6000600260005060008374ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000216000508054905090506105d7565b919050565b600060016000505490506105eb565b90565b600060036000508383604051808383808284378083019250505092505050908152602001604051809103902160009054906101000a900474ffffffffffffffffffffffffffffffffffffffffff169050610643565b92915050565b606060046000508054806020026020016040519081016040528092919081815260200182805480156106d257602002820191906000526020600021905b8160009054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610686575b505050505090506106de565b9056fea165627a7a723058200f7a21d1a52898fc27a8e8c988fe01386430c2472b52870bfac457b238845c580029",
    "hex"
).toString("base64")
export const VITENS_ADDRESS = "vite_1077691249858a325a4387fa77a203e494d08167fa6234bc01"

export async function resolveViteNS(name:string):Promise<string>{
    const result = await wsProvider.request(
        "contract_callOffChainMethod",
        {
            address: VITENS_ADDRESS,
            code: VITENS_OFFCHAIN_CODE,
            data: Buffer.from(
                vite.abi.encodeFunctionCall({
                    "constant": true,
                    "inputs": [
                        {
                            "name": "_vnsAddress",
                            "type": "string"
                        }
                    ],
                    "name": "resolveAddress",
                    "outputs": [
                        {
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "offchain"
                } as any, [name]),
                "hex"
            ).toString("base64")
        }
    )
    if(!result)throw new Error(`The vitens request reverted.`)
    const address = vite.abi.decodeParameter("address", Buffer.from(
        result,
        "base64"
    ).toString("hex"))
    
    if(address === nullAddress){
        throw new Error("This ViteNS name does not belong to anyone.")
    }

    return address
}